{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">{{ trip.name }} - Map View</h1>

<div class="mb-3">
    <a href="{{ url_for('routes.trip_detail', trip_id=trip.id) }}" class="btn btn-primary">Back to Trip Detail</a>
</div>

<div id="map" style="height: 600px; width: 100%;"></div>

<script>
function initMap() {
    const map = new google.maps.Map(document.getElementById('map'), {
        zoom: 6,
        center: {lat: 16.0, lng: 106.0}  // Center of Vietnam
    });

    const activities = {{ activities|tojson|safe }};
    const markers = [];
    const bounds = new google.maps.LatLngBounds();

    activities.forEach(activity => {
        if (activity.latitude && activity.longitude) {
            const marker = new google.maps.Marker({
                position: {lat: activity.latitude, lng: activity.longitude},
                map: map,
                title: activity.title
            });

            const infoWindow = new google.maps.InfoWindow({
                content: `<h5>${activity.title}</h5>
                          <p><strong>Date:</strong> ${activity.date}</p>
                          <p><strong>Time:</strong> ${activity.start_time} - ${activity.end_time}</p>
                          <p><strong>Location:</strong> ${activity.location}</p>
                          <p><strong>Category:</strong> ${activity.category}</p>`
            });

            marker.addListener('click', () => {
                infoWindow.open(map, marker);
            });

            markers.push(marker);
            bounds.extend(marker.getPosition());
        }
    });

    if (markers.length > 0) {
        map.fitBounds(bounds);
    }

    // Draw route
    const path = markers.map(marker => marker.getPosition());
    const route = new google.maps.Polyline({
        path: path,
        geodesic: true,
        strokeColor: '#FF0000',
        strokeOpacity: 1.0,
        strokeWeight: 2
    });

    route.setMap(map);
}
</script>
<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDFEcOBZtIfolnyQ03QQwVzzwWJbA1ErUA&callback=initMap">
</script>
{% endblock %}
