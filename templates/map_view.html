{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">{{ trip.name }} - Map View</h1>

<div class="mb-3">
    <a href="{{ url_for('routes.trip_detail', trip_id=trip.id) }}" class="btn btn-primary">Back to Trip Detail</a>
</div>

<div id="map" style="height: 600px; width: 100%;"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

<script>
function initMap() {
    const map = L.map('map').setView([16.0, 106.0], 6);  // Center of Vietnam

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const activities = {{ activities|tojson|safe }};
    const markers = [];
    const routeCoordinates = [];

    activities.forEach(activity => {
        if (activity.latitude && activity.longitude) {
            const marker = L.marker([activity.latitude, activity.longitude])
                .addTo(map)
                .bindPopup(`
                    <h5>${activity.title}</h5>
                    <p><strong>Date:</strong> ${activity.date}</p>
                    <p><strong>Time:</strong> ${activity.start_time} - ${activity.end_time}</p>
                    <p><strong>Location:</strong> ${activity.location}</p>
                    <p><strong>Category:</strong> ${activity.category}</p>
                `);
            markers.push(marker);
            routeCoordinates.push([activity.latitude, activity.longitude]);
        }
    });

    if (markers.length > 0) {
        const bounds = L.latLngBounds(routeCoordinates);
        map.fitBounds(bounds);
    }

    // Draw route
    L.polyline(routeCoordinates, {color: 'red'}).addTo(map);
}

document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}
