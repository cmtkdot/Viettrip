{% extends "base.html" %}

{% block content %}
<h1 class="mb-4">Weekly View - {{ trip.name }}</h1>

<form id="date-filter-form" class="mb-3">
  <div class="row">
    <div class="col-md-4 mb-2">
      <label for="start-date" class="form-label">Start Date</label>
      <input type="date" id="start-date" name="start-date" class="form-control" min="{{ trip.start_date }}" max="{{ trip.end_date }}" required>
    </div>
    <div class="col-md-4 mb-2">
      <label for="end-date" class="form-label">End Date</label>
      <input type="date" id="end-date" name="end-date" class="form-control" min="{{ trip.start_date }}" max="{{ trip.end_date }}" required>
    </div>
    <div class="col-md-4 mb-2 align-self-end">
      <button type="submit" class="btn btn-primary w-100">Apply Date Filter</button>
    </div>
  </div>
</form>

<form id="category-filter-form" class="mb-3">
  <h5>Filter by Category:</h5>
  <div class="row">
    {% for category in ['Travel', 'Accommodation', 'Sightseeing', 'Cultural', 'Food', 'Entertainment', 'Historical'] %}
    <div class="col-6 col-md-3 mb-2">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="{{ category }}" id="filter-{{ category.lower() }}" checked>
        <label class="form-check-label" for="filter-{{ category.lower() }}">{{ category }}</label>
      </div>
    </div>
    {% endfor %}
  </div>
  <div class="row mt-2">
    <div class="col">
      <button type="submit" class="btn btn-primary">Apply Filters</button>
    </div>
  </div>
</form>

<div class="weekly-view-container">
  <div class="weekly-calendar-container">
    <div class="row mb-3">
        <div class="col-4">
            <button id="prevWeek" class="btn btn-secondary w-100">< Previous Week</button>
        </div>
        <div class="col-4 text-center">
            <h2 id="weekRange" class="h4">{{ start_of_week.strftime('%b %d') }} - {{ (start_of_week + timedelta(days=6)).strftime('%b %d, %Y') }}</h2>
        </div>
        <div class="col-4 text-end">
            <button id="nextWeek" class="btn btn-secondary w-100">Next Week ></button>
        </div>
    </div>

    <div class="weekly-calendar">
        <div class="days-header">
            <div class="time-label-header"></div>
            {% for day in range(7) %}
                <div class="day-header">
                    {{ (start_of_week + timedelta(days=day)).strftime('%a %d') }}
                    <button class="btn btn-sm btn-outline-secondary toggle-day-view">Toggle</button>
                </div>
            {% endfor %}
        </div>
        <div class="time-rows">
            {% for hour in range(0, 24) %}
                <div class="time-row">
                    <div class="time-label">{{ '{:02d}:00'.format(hour) }}</div>
                    {% for day in range(7) %}
                        <div class="day-cell" data-day="{{ (start_of_week + timedelta(days=day)).strftime('%Y-%m-%d') }}" data-hour="{{ hour }}">
                            <!-- Activities will be populated dynamically -->
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    </div>
  </div>
  <div class="add-activity-container mt-3">
    <a href="{{ url_for('add_activity', trip_id=trip.id) }}" class="btn btn-primary btn-lg w-100">Add New Activity</a>
  </div>
</div>

<div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activityModalLabel">Activity Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="activityModalBody">
                <!-- Activity details will be populated here -->
            </div>
        </div>
    </div>
</div>

<div id="tripData" 
     data-trip-id="{{ trip.id }}"
     data-trip-start-date="{{ trip.start_date }}"
     data-trip-end-date="{{ trip.end_date }}"
     data-start-of-week="{{ start_of_week }}">
</div>

<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function() {
    const tripData = document.getElementById('tripData').dataset;
    const tripId = tripData.tripId;
    const tripStartDate = new Date(tripData.tripStartDate);
    const tripEndDate = new Date(tripData.tripEndDate);
    let currentStartDate = new Date(tripData.startOfWeek);

    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }

    function updateWeekRange() {
        const endDate = new Date(currentStartDate);
        endDate.setDate(endDate.getDate() + 6);
        document.getElementById('weekRange').textContent = currentStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' - ' + endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function loadActivities() {
        const endDate = new Date(currentStartDate);
        endDate.setDate(endDate.getDate() + 6);
        const categories = Array.from(document.querySelectorAll('#category-filter-form input:checked')).map(input => input.value);
        
        fetch('/weekly_view_data/' + tripId + '?start_date=' + formatDate(currentStartDate) + '&end_date=' + formatDate(endDate) + '&categories=' + categories.join(','))
            .then(response => response.json())
            .then(data => {
                document.querySelectorAll('.activity-item').forEach(el => el.remove());
                for (const [date, activities] of Object.entries(data)) {
                    activities.forEach(activity => {
                        const cell = document.querySelector('.day-cell[data-day="' + date + '"][data-hour="' + activity.start_time.split(':')[0] + '"]');
                        if (cell) {
                            const activityElement = document.createElement('div');
                            activityElement.className = 'activity-item';
                            activityElement.dataset.activityId = activity.id;
                            activityElement.dataset.category = activity.category;
                            activityElement.style.height = (activity.duration_minutes / 60 * 100) + '%';
                            activityElement.innerHTML = 
                                '<div class="activity-content">' +
                                    '<strong>' + activity.title + '</strong><br>' +
                                    '<small>' + activity.start_time + ' - ' + activity.end_time + '</small>' +
                                '</div>' +
                                '<div class="activity-details">' +
                                    '<p><strong>Location:</strong> ' + activity.location + '</p>' +
                                    '<p><strong>Category:</strong> ' + activity.category + '</p>' +
                                    '<p><strong>Price:</strong> $' + activity.price.toFixed(2) + '</p>' +
                                '</div>';
                            cell.appendChild(activityElement);
                        }
                    });
                }
            });
    }

    document.getElementById('prevWeek').addEventListener('click', function() {
        currentStartDate.setDate(currentStartDate.getDate() - 7);
        if (currentStartDate < tripStartDate) {
            currentStartDate = new Date(tripStartDate);
        }
        updateWeekRange();
        loadActivities();
    });

    document.getElementById('nextWeek').addEventListener('click', function() {
        currentStartDate.setDate(currentStartDate.getDate() + 7);
        if (currentStartDate > tripEndDate) {
            currentStartDate.setDate(tripEndDate.getDate() - 6);
        }
        updateWeekRange();
        loadActivities();
    });

    document.getElementById('date-filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const startDate = new Date(document.getElementById('start-date').value);
        const endDate = new Date(document.getElementById('end-date').value);
        if (startDate <= endDate) {
            currentStartDate = startDate;
            updateWeekRange();
            loadActivities();
        }
    });

    document.getElementById('category-filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        loadActivities();
    });

    loadActivities();
});
</script>
{% endblock %}
